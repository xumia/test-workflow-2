# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
  - master

pr: none

parameters:
- name: definitions
  type: string
  default: |
    3,main
- name: defaultBranches
  type: string
  default: 'main master 202111 202106 202012 202006 201911'

pool:
  vmImage: 'ubuntu-20.04'

steps:
- task: PythonScript@0
  env:
    ACCESS_TOKEN: $(System.AccessToken)
  inputs:
    scriptSource: inline
    script: |
      import datetime, base64, json, time, os, re
      from urllib import request

      authentication = 'Basic {0}'.format(os.environ.get("ACCESS_TOKEN"))
      url = '$(System.CollectionUri)$(System.TeamProjectId)/_apis/build/builds?api-version=6.0'
      print(url)
      defaultBranches = "${{ parameters.defaultBranches }}".split(' ')
      definitions = """${{ parameters.definitions }}"""
      for line in definitions.splitlines():
        items = line.split(',')
        definitionId = items[0]
        branches = defaultBranches
        if len(items) > 1:
          branches = items[1].split(' ')

        for branch in branches:
          req = request.Request(url, method="POST")
          req.add_header('Content-Type', 'application/json')
          req.add_header('Authorization', authentication)
          data = {}
          definition = {}
          definition['id'] = definitionId
          definition['sourceBranch'] = branch
          data['definition'] = definition
          print(data)
          r = request.urlopen(req, data=data)
          content = r.read()
          print(content)